var ToVault=function(){"use strict";const e={name:"browser_identity",async collect(){const e=performance.now();return{userAgent:navigator.userAgent,clientHints:await this._getHighEntropyValues(),language:navigator.language,platform:navigator.platform,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,screenDepth:window.screen.colorDepth,time:parseFloat((performance.now()-e).toFixed(4))}},_getHighEntropyValues:async()=>navigator.userAgentData&&navigator.userAgentData.getHighEntropyValues?await navigator.userAgentData.getHighEntropyValues(["architecture","model","platformVersion"]):null},t={async collect(){const e=performance.now(),t=this._generateSecureCanvas();await new Promise(e=>setTimeout(e,10));const r=t!==this._generateSecureCanvas();return{canvasHash:t,security:{noiseDetected:r,integrityScore:r?.1:1,isLying:void 0===navigator.hardwareConcurrency},specs:{cores:navigator.hardwareConcurrency||0,memory:navigator.deviceMemory||0,screen:`${window.screen.width}x${window.screen.height}`,depth:window.screen.colorDepth},time:parseFloat((performance.now()-e).toFixed(4))}},_generateSecureCanvas(){const e=document.createElement("canvas");e.width=240,e.height=60;const t=e.getContext("2d");t.textBaseline="top",t.font="16px 'Arial', 'Helvetica Neue', sans-serif",t.fillStyle="rgba(12, 165, 233, 0.5)",t.fillRect(100,5,50,40);const r=t.createLinearGradient(0,0,150,0);return r.addColorStop(0,"#1e293b"),r.addColorStop(1,"#38bdf8"),t.fillStyle=r,t.fillText("to-vault-sdk-v1 üõ°Ô∏è",5,10),t.beginPath(),t.moveTo(10,45),t.bezierCurveTo(40,55,120,15,230,45),t.strokeStyle="magenta",t.stroke(),this._simpleHash(e.toDataURL())},_simpleHash(e){let t=0;for(let r=0;r<e.length;r++){t=(t<<5)-t+e.charCodeAt(r),t&=t}return Math.abs(t).toString(16)}},r={async collect(){const e=performance.now(),[t,r]=await Promise.all([this._getNetworkData(),this._getAutomationData()]);return{network:t,automation:r,riskScore:r.isBot||t.vpnInferred?"High":"Low",time:parseFloat((performance.now()-e).toFixed(4))}},async _getNetworkData(){const e=await this._getWebRTCCandidates();let t="Unknown";try{const e=await fetch("https://api.ipify.org?format=json",{signal:AbortSignal.timeout(2e3)});t=(await e.json()).ip}catch(e){}const r=(new Date).getTimezoneOffset();return{publicIp:t,localIpCandidates:e,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,timezoneOffset:r,vpnInferred:e.some(e=>e.includes(".local"))}},_getAutomationData:async()=>({webdriver:navigator.webdriver||!1,protoInconsistency:"Navigator"!==navigator.constructor.name||void 0===navigator.languages,isHeadless:/HeadlessChrome/.test(navigator.userAgent)||0===navigator.languages.length,hasAutomationFlags:!!(window.document.documentElement.getAttribute("webdriver")||window.callPhantom||window._phantom||window.__nightmare),get isBot(){return this.webdriver||this.isHeadless||this.hasAutomationFlags}}),_getWebRTCCandidates:()=>new Promise(e=>{const t=[],r=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19002"}]});r.onicecandidate=o=>{if(o.candidate){const e=o.candidate.candidate,r=/([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9\-]+\.local)/.exec(e);r&&!t.includes(r[1])&&t.push(r[1])}else r.close(),e(t)},r.createDataChannel("check"),r.createOffer().then(e=>r.setLocalDescription(e)),setTimeout(()=>e(t),800)})},o={runIdle(e){window.requestIdleCallback?window.requestIdleCallback(()=>e()):setTimeout(()=>e(),1)},generateNonce(e=16){const t=new Uint8Array(e);return window.crypto.getRandomValues(t),Array.from(t,e=>e.toString(16).padStart(2,"0")).join("")},withTimeout(e,t){const r=new Promise((e,r)=>setTimeout(()=>r(new Error("Timeout")),t));return Promise.race([e,r])}},a={build(e,t){return{metadata:{version:"1.0.0",timestamp:(new Date).toISOString(),nonce:o.generateNonce(),projectId:t.projectId,userId:t.userId},payload:{browser:e.browser,hardware:e.hardware,network:e.network},health:{executionTime:performance.now(),errors:this._collectErrors(e)}}},_collectErrors:e=>Object.keys(e).filter(t=>"Error"===e[t].status).map(t=>({module:t,message:e[t].message}))},n={async encrypt(e,t){try{const r=await this._importKey(t),o=await window.crypto.subtle.generateKey({name:"AES-GCM",length:256},!0,["encrypt"]),a=window.crypto.getRandomValues(new Uint8Array(12)),n=(new TextEncoder).encode(JSON.stringify(e)),i=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:a},o,n),s=await window.crypto.subtle.exportKey("raw",o),c=await window.crypto.subtle.encrypt({name:"RSA-OAEP"},r,s);return this._serialize(c,a,i)}catch(e){throw console.error("Error en el motor criptogr√°fico:",e),e}},async _importKey(e){try{const t=e.replace(/-----BEGIN PUBLIC KEY-----/g,"").replace(/-----END PUBLIC KEY-----/g,"").replace(/\s/g,""),r=window.atob(t),o=new Uint8Array(r.length);for(let e=0;e<r.length;e++)o[e]=r.charCodeAt(e);return await window.crypto.subtle.importKey("spki",o.buffer,{name:"RSA-OAEP",hash:"SHA-256"},!0,["encrypt"])}catch(e){throw new Error("Error al importar la llave p√∫blica: "+e.message)}},_serialize(e,t,r){const o=e=>btoa(String.fromCharCode(...new Uint8Array(e)));return[o(e),o(t),o(r)].join(".")}},i={_config:null,_isReady:!1,async init(e){if(e.projectId&&e.publicKey)return this._config={projectId:e.projectId,publicKey:e.publicKey,userId:e.userId||"anonymous",options:e.options||{strict:!1}},this._isReady=!0,console.log("To-VaultSDK: Inicializado con √©xito."),this;console.error("To-VaultSDK: Faltan par√°metros cr√≠ticos (projectId o publicKey).")},async collect(){if(!this._isReady)throw new Error("SDK no inicializado. Llama a .init() primero.");return new Promise(i=>{o.runIdle(async()=>{try{const[o,s,c]=await Promise.all([e.collect(),t.collect(),r.collect()]),l=a.build({browser:o,hardware:s,network:c},this._config),d=await n.encrypt(l,this._config.publicKey);i(d)}catch(e){console.error("To-VaultSDK Error:",e),i(null)}})})}};return"undefined"!=typeof window&&(window.ToVault=i),i}();
